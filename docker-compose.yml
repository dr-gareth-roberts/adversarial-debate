# Adversarial Debate - Docker Compose Configuration
#
# Usage:
#   docker-compose run --rm analyze analyze exploit ./src
#   docker-compose run --rm analyze analyze break ./src
#   docker-compose run --rm analyze analyze chaos ./src
#
# With custom API key:
#   ANTHROPIC_API_KEY=your-key docker-compose run --rm analyze analyze exploit ./src
#
# With OpenAI:
#   OPENAI_API_KEY=your-key docker-compose --profile openai run --rm analyze-openai analyze exploit ./src
#
# With local Ollama:
#   docker-compose --profile ollama up -d ollama
#   docker-compose --profile ollama run --rm analyze-ollama analyze exploit ./src

services:
  # ==========================================================================
  # Main analysis service (Anthropic - default)
  # ==========================================================================
  analyze:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ADVERSARIAL_OUTPUT_DIR=/output
      - ADVERSARIAL_BEAD_LEDGER=/output/beads/ledger.jsonl
      - ADVERSARIAL_LOG_LEVEL=${ADVERSARIAL_LOG_LEVEL:-INFO}
      - ADVERSARIAL_LOG_FORMAT=${ADVERSARIAL_LOG_FORMAT:-text}
    volumes:
      # Mount current directory for code analysis
      - .:/code:ro
      # Mount output directory for results
      - ./output:/output
    working_dir: /code
    # Security options
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=100M

  # ==========================================================================
  # OpenAI provider service
  # ==========================================================================
  analyze-openai:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        INSTALL_OPENAI: "true"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LLM_PROVIDER=openai
      - LLM_MODEL=${LLM_MODEL:-gpt-4o}
      - ADVERSARIAL_OUTPUT_DIR=/output
      - ADVERSARIAL_BEAD_LEDGER=/output/beads/ledger.jsonl
      - ADVERSARIAL_LOG_LEVEL=${ADVERSARIAL_LOG_LEVEL:-INFO}
      - ADVERSARIAL_LOG_FORMAT=${ADVERSARIAL_LOG_FORMAT:-text}
    volumes:
      - .:/code:ro
      - ./output:/output
    working_dir: /code
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=100M
    profiles:
      - openai

  # ==========================================================================
  # Azure OpenAI provider service
  # ==========================================================================
  analyze-azure:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        INSTALL_OPENAI: "true"
    environment:
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AZURE_OPENAI_DEPLOYMENT=${AZURE_OPENAI_DEPLOYMENT}
      - AZURE_OPENAI_API_VERSION=${AZURE_OPENAI_API_VERSION:-2024-02-01}
      - LLM_PROVIDER=azure
      - ADVERSARIAL_OUTPUT_DIR=/output
      - ADVERSARIAL_BEAD_LEDGER=/output/beads/ledger.jsonl
      - ADVERSARIAL_LOG_LEVEL=${ADVERSARIAL_LOG_LEVEL:-INFO}
      - ADVERSARIAL_LOG_FORMAT=${ADVERSARIAL_LOG_FORMAT:-text}
    volumes:
      - .:/code:ro
      - ./output:/output
    working_dir: /code
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=100M
    profiles:
      - azure

  # ==========================================================================
  # Ollama local inference service
  # ==========================================================================
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    profiles:
      - ollama

  # Ollama-based analysis (requires ollama service running)
  analyze-ollama:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
      - LLM_PROVIDER=ollama
      - LLM_MODEL=${LLM_MODEL:-llama3.2}
      - ADVERSARIAL_OUTPUT_DIR=/output
      - ADVERSARIAL_BEAD_LEDGER=/output/beads/ledger.jsonl
      - ADVERSARIAL_LOG_LEVEL=${ADVERSARIAL_LOG_LEVEL:-INFO}
      - ADVERSARIAL_LOG_FORMAT=${ADVERSARIAL_LOG_FORMAT:-text}
    volumes:
      - .:/code:ro
      - ./output:/output
    working_dir: /code
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=100M
    depends_on:
      ollama:
        condition: service_healthy
    profiles:
      - ollama

  # ==========================================================================
  # Full provider image (all providers installed)
  # ==========================================================================
  analyze-full:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        INSTALL_ALL_PROVIDERS: "true"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY:-}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT:-}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://localhost:11434}
      - LLM_PROVIDER=${LLM_PROVIDER:-anthropic}
      - LLM_MODEL=${LLM_MODEL:-}
      - ADVERSARIAL_OUTPUT_DIR=/output
      - ADVERSARIAL_BEAD_LEDGER=/output/beads/ledger.jsonl
      - ADVERSARIAL_LOG_LEVEL=${ADVERSARIAL_LOG_LEVEL:-INFO}
      - ADVERSARIAL_LOG_FORMAT=${ADVERSARIAL_LOG_FORMAT:-text}
    volumes:
      - .:/code:ro
      - ./output:/output
    working_dir: /code
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=100M
    profiles:
      - full

  # ==========================================================================
  # Development service with full access
  # ==========================================================================
  dev:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        INSTALL_ALL_PROVIDERS: "true"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY:-}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT:-}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://localhost:11434}
      - LLM_PROVIDER=${LLM_PROVIDER:-anthropic}
      - ADVERSARIAL_OUTPUT_DIR=/output
      - ADVERSARIAL_BEAD_LEDGER=/output/beads/ledger.jsonl
      - ADVERSARIAL_LOG_LEVEL=DEBUG
      - ADVERSARIAL_LOG_FORMAT=text
    volumes:
      - .:/code
      - ./output:/output
    working_dir: /code
    entrypoint: /bin/bash
    stdin_open: true
    tty: true

  # ==========================================================================
  # Run tests
  # ==========================================================================
  test:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        INSTALL_ALL_PROVIDERS: "true"
        INSTALL_DEV: "true"
    volumes:
      - .:/app
    working_dir: /app
    entrypoint: ["python", "-m", "pytest"]
    command: ["tests/", "-v"]
    environment:
      - PYTHONPATH=/app/src

  # ==========================================================================
  # Watch mode service
  # ==========================================================================
  watch:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ADVERSARIAL_OUTPUT_DIR=/output
      - ADVERSARIAL_BEAD_LEDGER=/output/beads/ledger.jsonl
      - ADVERSARIAL_LOG_LEVEL=${ADVERSARIAL_LOG_LEVEL:-INFO}
      - ADVERSARIAL_LOG_FORMAT=${ADVERSARIAL_LOG_FORMAT:-text}
    volumes:
      - .:/code:ro
      - ./output:/output
    working_dir: /code
    command: ["watch", "--agent", "${WATCH_AGENT:-all}", "/code/src"]
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=100M
    profiles:
      - watch

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  ollama_data:
    driver: local

# ==========================================================================
# Networks
# ==========================================================================
networks:
  default:
    driver: bridge
